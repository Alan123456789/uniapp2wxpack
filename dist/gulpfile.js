"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("del")),r=e(require("gulp")),n=e(require("path")),a=e(require("commander")),s=e(require("single-line-log")),p=e(require("gulp-load-plugins")),i=e(require("vue-template-compiler")),o=e(require("preprocess")),c=e(require("fs-extra")),l=e(require("strip-json-comments")),u=e(require("gulp-strip-comments"));const{program:g}=a;g.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式").option("--type <type>","解耦包类型(哪种小程序)","weixin").option("--native","原生模式"),g.parse(process.argv);const f={weixin:{html:"wxml",css:"wxss",globalObject:"wx",mainMpPath:"mainWeixinMpPath",directivePrefix:"wx:"},baidu:{html:"swan",css:"css",globalObject:"swan",mainMpPath:"mainBaiduMpPath",directivePrefix:"s-"},toutiao:{html:"ttml",css:"ttss",globalObject:"tt",mainMpPath:"mainToutiaoMpPath",directivePrefix:"tt:"},alipay:{html:"axml",css:"acss",globalObject:"my",mainMpPath:"mainAlipayMpPath",directivePrefix:"a:"}},h=f[g.type];if(!h)throw Error("小程序类型错");process.env.PACK_TYPE=g.type;const m=g.scope,d=function(){return require.apply(null,arguments)}(n.resolve(m,"./projectToSubPackageConfig")),P=d.sourceCodePath||"src",y=d.wxResourcePath||`${P}/${h.globalObject}resource`,v=d.wxResourceAlias||"@wxResource",b=RegExp(v+"\\/","g"),w=d.uniRequireApiName||"__uniRequireWx",k=RegExp(w+"\\(([a-zA-Z.\\/\"'@\\d-_]+)\\)","g"),j=d.uniImportWxssApiName||"__uniWxss",x=RegExp(`(}|^|\\s|;)${j}\\s*{([^{}]+)}`,"g");let $="dev";"production"===process.env.NODE_ENV&&($="build");const S="dist/"+$+"/mp-"+g.type;let _="dist/"+$+`/mp-${g.type}-pack`;g.plugin&&(_="dist/"+$+`/mp-${g.type}-pack-plugin`);var E={pluginProcessFileTypes:d.pluginProcessFileTypes||["js","json","wxml","ttml","ttss","swan","css","html","wxss","htm","wxs","sjs","acss","axml"],currentNamespace:h,program:g,cwd:m,projectToSubPackageConfig:d,wxResourcePath:y,wxResourceAlias:v,regExpWxResources:b,uniRequireApiName:w,regExpUniRequire:k,uniImportWxssApiName:j,regExpUniImportWxss:x,configWxResourceKey:d.configWxResourceKey||"wxResource",env:$,base:S,target:_,basePath:n.resolve(m,S),subModePath:n.resolve(m,_,d.subPackagePath),targetPath:n.resolve(m,_),packIsSubpackage:{mode:!1},mpTypeNamespace:f,sourceCodePath:P};let O;const A=s.stdout;var N={tryAgain:async function(e){return new Promise(async t=>{setTimeout(async()=>{t(await e())},100)})},getLevelPath:function(e){return Array(e).fill("../").join("")},getLevel:function(e){return e.split(/[\\/]/).length-1},writeLastLine:function(e){A(e),clearTimeout(O),O=setTimeout(()=>{A("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)},deepFind:function e(t,r,n,a){r&&(r(t,n,a),t.childNodes?t.childNodes.forEach((t,n,a)=>{e(t,r,n,a)}):t.children&&t.children.forEach((t,n,a)=>{e(t,r,n,a)}))}};const{basePath:R}=E,{tryAgain:C}=N;r.task("clean:base",(async function e(r){try{await t([R+"/**/*"],{force:!0})}catch(t){return void await C(async()=>{await e(r)})}r()}));const{subModePath:T}=E,{tryAgain:M}=N;r.task("clean:subModePath",(async function e(r){try{await t([T+"/**/*"],{force:!0})}catch(t){return void await M(async()=>{await e(r)})}r()}));const{targetPath:L}=E,{tryAgain:B}=N;r.task("clean:previewDist",(async function e(r){try{await t([L+"/**/*"],{force:!0})}catch(t){return void await B(async()=>{await e(r)})}r()}));const{compile:q}=i;var F=class{constructor(e){this.topNode={children:[]},this.init(e)}init(e){this.topNode=q(`<div>${e}</div>`).ast}getAttr(e,t){return e.attrsMap&&e.attrsMap[t]||""}setAttr(e,t,r){if(!e.attrsMap)return"";e.attrsMap[t]=r}render(e=this.topNode.children,t=""){return e.reduce((e,t)=>{if(t.removed)return e;if(1===t.type&&!t.tag)return e;if(3===t.type||2===t.type)return e+=this.writeText(t);const{tag:r,attrsMap:n,children:a=[]}=t;return e+=this.writeOpenTag(r,n),e+=this.render(a),e+=this.writeCloseTag(r)},t)}writeOpenTag(e,t){if(t){const r=Object.keys(t).map(e=>t[e].indexOf('"')>-1&&0>t[e].indexOf("'")?`${e}='${t[e]}'`:`${e}="${t[e]}"`);return`<${e}${r.length>0?" "+r.join(" "):""}>`}return`<${e}>`}writeText(e){return e.text}writeCloseTag(e){return`</${e}>`}};const{currentNamespace:J,mpTypeNamespace:W}=E,{deepFind:I}=N,U=Object.keys(W).map(e=>W[e].directivePrefix),K=Object.keys(W).map(e=>W[e].html),D=RegExp(`^(${U.join("|")})`),Y=RegExp(`\\.(${K.join("|")})$`,"i");var H=function(e,t){if(t.relative.match(Y)){const t=new F(e);return I(t.topNode,e=>{if(!e.tag||3===e.type)return;const r=t.getAttr(e,"class");"toutiao"===process.env.PACK_TYPE&&r&&!r.match(/(^\s|(\s$))/)&&t.setAttr(e,"class",r+" ");const n=t.getAttr(e,"catchTap");"toutiao"===process.env.PACK_TYPE&&n&&!t.getAttr(e,"bindTap")&&t.setAttr(e,"bindTap",n);const a=t.getAttr(e,"src");e.tag.match(/^(include|import)$/)&&a&&t.setAttr(e,"src",a.replace(Y,"."+J.html)),e.attrsMap&&Object.keys(e.attrsMap).forEach(t=>{if(t.match(D)){const r=t.replace(D,J.directivePrefix);e.attrsMap[r]=e.attrsMap[t],r!==t&&delete e.attrsMap[t]}})}),t.render()}return e};const{currentNamespace:z,mpTypeNamespace:V}=E,Z=Object.keys(V).map(e=>V[e].css),G=RegExp(`\\.(${Z.join("|")})$`,"i");var Q=function(e,{relative:t}){return t.match(G)&&(e=e.replace(/@import\s*['"](\S+)['"]/g,(function(e,t){return`@import '${t.replace(G,"."+z.css)}'`}))),e};var X=function(e,{relative:t}){return"toutiao"===process.env.PACK_TYPE&&t.match(/^\/app.js$/i)?"\nif (!Promise.prototype.finally) {\n    Promise.prototype.finally = function (callback) {\n        let P = this.constructor;\n        return this.then(\n            value  => P.resolve(callback()).then(() => value),\n            reason => P.resolve(callback()).then(() => { throw reason })\n        );\n    };\n}\n;\n"+e:e};const{preprocess:ee}=o;var te=function(e,{relative:t}){if(t.match(/.js$/i))try{return ee(e,process.env,{type:"js"})}catch(t){return console.log("js条件编译出错"),console.log(t),e}return e};const{currentNamespace:re}=E,{preprocess:ne}=o;var ae=function(e,{relative:t}){if(t.match(RegExp(`.${re.css}$`,"i")))try{return ne(e,process.env,{type:"css"})}catch(t){return console.log(re.css+"条件编译出错"),console.log(t),e}return e};const{currentNamespace:se}=E,{preprocess:pe}=o;var ie={htmlMixinPlugin:H,cssMixinPlugin:Q,polyfillPlugin:X,jsPreProcessPlugin:te,cssPreProcessPlugin:ae,htmlPreProcessPlugin:function(e,{relative:t}){if(t.match(RegExp(`.${se.html}$`,"i")))try{return pe(e,process.env,{type:"html"})}catch(t){return console.log(se.html+"条件编译出错"),console.log(t),e}return e}};const{projectToSubPackageConfig:oe,targetPath:ce}=E;(!oe.plugins||!oe.plugins instanceof Array)&&(oe.plugins=[]);var le={runPlugins:function(e){return function(t){const{plugins:r}=oe;if(!r||!r instanceof Array)return;const a=n.resolve(e,this.file.relative),s={relative:a.replace(RegExp("^"+ce.replace(/\\/g,"\\\\")),"").replace(/\\/g,"/"),absolute:a};return r.reduce((e,t)=>{if("string"==typeof t&&(t=ie[t]),"function"!=typeof t)return e;const r=t(e,s,ie);return null==r?e:r},t)}}};const ue=p(),{cwd:ge,projectToSubPackageConfig:fe,target:he,env:me,pluginProcessFileTypes:de,sourceCodePath:Pe}=E,{writeLastLine:ye}=N,{runPlugins:ve}=le;r.task("watch:pluginJson",(function(){const e=ue.filter(de.map(e=>"/**/*."+e),{restore:!0});return r.src(Pe+"/plugin.json",{allowEmpty:!0,cwd:ge}).pipe(ue.if("dev"===me,ue.watch(Pe+"/plugin.json",{cwd:ge},(function(e){ye("处理"+e.relative+"......")})))).pipe(e).pipe(ue.replace(/[\s\S]*/,ve(n.resolve(ge,he+"/"+fe.subPackagePath)),{skipBinary:!1})).pipe(e.restore).pipe(r.dest(he+"/"+fe.subPackagePath,{cwd:ge}))}));const be=p(),{cwd:we,target:ke,env:je,targetPath:xe,pluginProcessFileTypes:$e}=E,{writeLastLine:Se}=N,{runPlugins:_e}=le;r.task("watch:projectConfigJson",(function(){const e=be.filter($e.map(e=>"/**/*."+e),{restore:!0});return r.src("project.config.json",{allowEmpty:!0,cwd:we}).pipe(be.if("dev"===je,be.watch("project.config.json",{cwd:we},(function(e){Se("处理"+e.relative+"......")})))).pipe(e).pipe(be.replace(/[\s\S]*/,_e(xe),{skipBinary:!1})).pipe(e.restore).pipe(r.dest(ke,{cwd:we}))}));const{program:Ee,cwd:Oe,projectToSubPackageConfig:Ae,basePath:Ne,subModePath:Re,targetPath:Ce,packIsSubpackage:Te,currentNamespace:Me}=E;var Le=function(){if(Ee.plugin)return;const e=n.resolve(Oe,Ae[Me.mainMpPath]+"/app.js");if(c.existsSync(e)){const t=c.readFileSync(e,"utf8");let r=`require('${`./${Ae.subPackagePath}/`}app.js');\n`;if(Re===Ce){r=c.readFileSync(Ne+"/app.js","utf8")+";\n"}(Te.mode||Ee.plugin)&&(r=""),c.outputFileSync(Ce+"/app.js",r+t)}};const Be=p(),{program:qe,cwd:Fe,projectToSubPackageConfig:Je,configWxResourceKey:We,base:Ie,packIsSubpackage:Ue,currentNamespace:Ke,sourceCodePath:De}=E,{writeLastLine:Ye}=N;var He=function(e){return Ye("处理app.json......"),Be.replace(/[\s\S]+/,(function(t){if(qe.plugin&&"mainAppJson"===e)return t;Ue.mode=!1;let r,a,s,p={};({pagesJson(){try{r=JSON.parse(l(t))}catch(e){r={}}},baseAppJson(){try{a=JSON.parse(t)}catch(e){a={}}},mainAppJson(){try{s=JSON.parse(t)}catch(e){s={}}}})[e]();try{r||(r=JSON.parse(l(c.readFileSync(n.resolve(Fe,De+"/pages.json"),"utf8"))))}catch(e){r={}}try{a||(a=JSON.parse(c.readFileSync(n.resolve(Fe,Ie+"/app.json"),"utf8")))}catch(e){a={}}try{s||(s=JSON.parse(c.readFileSync(n.resolve(Fe,Je[Ke.mainMpPath]+"/app.json"),"utf8")))}catch(e){s={}}function i(e){return Je.subPackagePath+(Je.subPackagePath?"/":"")+e}if(s.subPackages){let e=s.subPackages.find(e=>e.root===Je.subPackagePath);if(e){Ue.mode=!0;let t=[...r[We]&&r[We].pages||[],...a.pages||[]];return a.subPackages&&a.subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),r[We]&&r[We].subPackages&&r[We].subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),e.pages=t,Le(),delete a.pages,delete a.subPackages,JSON.stringify({...a,...s},null,2)}}a.pages&&a.pages.forEach((e,t)=>{a.pages[t]=i(e)}),a.subPackages&&a.subPackages.forEach(e=>{e.root=i(e.root)}),r[We]&&(r[We].pages&&r[We].pages.forEach((e,t)=>{r[We].pages[t]=i(e)}),r[We].subPackages&&r[We].subPackages.forEach(e=>{e.root=i(e.root)})),a.tabBar&&a.tabBar.list&&a.tabBar.list.forEach(({pagePath:e,iconPath:t,selectedIconPath:r,...n},s)=>{a.tabBar.list[s]={pagePath:e?i(e):"",iconPath:t?i(t):"",selectedIconPath:r?i(r):"",...n}}),p={...a,...s},p.pages=Array.from(new Set([...r.indexPage?[i(r.indexPage)]:[],...s.pages||[],...a.pages||[],...r[We]&&r[We].pages||[]]));let o=[],u={};function g(e){e.forEach(e=>{u[e.root]=u[e.root]?Array.from(new Set([...u[e.root],...e.pages])):e.pages})}g(r[We]&&r[We].subPackages||[]),g(a.subPackages||[]),g(s.subPackages||[]);for(let e in u)o.push({root:e,pages:u[e]});if(p.subPackages=[...o],a.usingComponents){for(let e in a.usingComponents)a.usingComponents[e]="/"+Je.subPackagePath+a.usingComponents[e];p.usingComponents={...p.usingComponents||{},...a.usingComponents}}return Le(),"toutiao"===qe.type&&p.subPackages&&(p.subPackages.forEach(e=>{e.pages.forEach(t=>{p.pages.push((e.root+"/"+t).replace(/\/\//g,"/"))})}),delete p.subPackages),JSON.stringify(p,null,2)}),{skipBinary:!1})};const ze=p(),{cwd:Ve,target:Ze,env:Ge,targetPath:Qe,pluginProcessFileTypes:Xe,sourceCodePath:et}=E,{writeLastLine:tt}=N,{runPlugins:rt}=le;r.task("watch:pagesJson",(function(){const e=ze.filter(Xe.map(e=>"/**/*."+e),{restore:!0});return r.src(et+"/pages.json",{allowEmpty:!0,cwd:Ve}).pipe(ze.if("dev"===Ge,ze.watch(et+"/pages.json",{cwd:Ve},(function(e){tt("处理"+e.relative+"......")})))).pipe(He("pagesJson")).pipe(ze.rename("app.json")).pipe(e).pipe(ze.replace(/[\s\S]*/,rt(Qe),{skipBinary:!1})).pipe(e.restore).pipe(r.dest(Ze,{cwd:Ve}))}));const nt=p(),{cwd:at,target:st,env:pt,base:it,targetPath:ot,pluginProcessFileTypes:ct}=E,{writeLastLine:lt}=N,{runPlugins:ut}=le;r.task("watch:baseAppJson",(function(){const e=nt.filter(ct.map(e=>`${it}/**/*.${e}`),{restore:!0});return r.src(it+"/app.json",{allowEmpty:!0,cwd:at}).pipe(nt.if("dev"===pt,nt.watch(it+"/app.json",{cwd:at},(function(e){lt("处理"+e.relative+"......")})))).pipe(He("baseAppJson")).pipe(e).pipe(nt.replace(/[\s\S]*/,ut(ot),{skipBinary:!1})).pipe(e.restore).pipe(r.dest(st,{cwd:at}))}));const gt=p(),{cwd:ft,target:ht,env:mt,projectToSubPackageConfig:dt,program:Pt,currentNamespace:yt,pluginProcessFileTypes:vt}=E,{writeLastLine:bt}=N,{runPlugins:wt}=le;r.task("watch:mainAppJson",(function(){const e=dt[yt.mainMpPath],t=gt.filter(vt.map(t=>`${e}/**/*.${t}`),{restore:!0});return r.src(e+"/app.json",{allowEmpty:!0,cwd:ft}).pipe(gt.if("dev"===mt,gt.watch(e+"/app.json",{cwd:ft},(function(e){bt("处理"+e.relative+"......")})))).pipe(He("mainAppJson")).pipe(t).pipe(gt.replace(/[\s\S]*/,wt(n.resolve(ft,ht+(Pt.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(t.restore).pipe(r.dest(ht+(Pt.plugin?"/miniprogram":""),{cwd:ft}))}));const kt=p(),{cwd:jt,target:xt,env:$t,projectToSubPackageConfig:St,program:_t,basePath:Et,currentNamespace:Ot,mpTypeNamespace:At,pluginProcessFileTypes:Nt}=E,{writeLastLine:Rt}=N,{runPlugins:Ct}=le;r.task("watch:topMode-mainAppJsAndAppWxss",(function(){let e=St[Ot.mainMpPath];const t=Object.keys(At).map(t=>`${e}/app.${At[t].css}`),a=kt.filter([...t],{restore:!0}),s=kt.filter([e+"/app.js"],{restore:!0}),p=kt.filter(Nt.map(t=>`${e}/**/*.${t}`),{restore:!0});return r.src([e+"/app.js",...t],{allowEmpty:!0,cwd:jt}).pipe(kt.if("dev"===$t,kt.watch([e+"/app.js",`${e}/app.${Ot.css}`],{cwd:jt},(function(e){Rt("处理"+e.relative+"......")})))).pipe(s).pipe(kt.replace(/^/,(function(e){return c.readFileSync(Et+"/app.js","utf8")+";\n"}),{skipBinary:!1})).pipe(s.restore).pipe(a).pipe(kt.replace(/^/,(function(e){return c.readFileSync(`${Et}/app.${Ot.css}`,"utf8")+"\n"}),{skipBinary:!1})).pipe(kt.rename((function(e){e.extname="."+Ot.css}))).pipe(a.restore).pipe(p).pipe(kt.replace(/[\s\S]*/,Ct(n.resolve(jt,xt+(_t.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(p.restore).pipe(r.dest(xt+(_t.plugin?"/miniprogram":""),{cwd:jt}))}));const{mpTypeNamespace:Tt,currentNamespace:Mt}=E,Lt=(process,new Set(Object.keys(Tt).map(e=>Tt[e].globalObject)));var Bt={mixinsEnvCode:function(e){let t="";return Lt.forEach(e=>{Mt.globalObject!==e&&(t+=`var ${e} = ${Mt.globalObject};\n`)}),t}};const qt=p(),{cwd:Ft,target:Jt,env:Wt,projectToSubPackageConfig:It,base:Ut,wxResourcePath:Kt,currentNamespace:Dt,mpTypeNamespace:Yt,pluginProcessFileTypes:Ht}=E,{writeLastLine:zt}=N,{mixinsEnvCode:Vt}=Bt,{runPlugins:Zt}=le;r.task("watch:mainWeixinMpPackPath",(function(){const e=It[Dt.mainMpPath],a=e+"/"+It.subPackagePath,s=Jt+"/"+It.subPackagePath,p=[],i=[],o=new Set,l=new Set;Object.keys(Yt).forEach(e=>{p.push(`${a}/**/*.${Yt[e].css}`),i.push(`${a}/**/*.${Yt[e].html}`),o.add("."+Yt[e].css),l.add("."+Yt[e].html)});const u=qt.filter([...i],{restore:!0}),g=qt.filter([...p],{restore:!0}),f=qt.filter([a+"/**/*.js"],{restore:!0}),h=qt.filter(Ht.map(e=>`${a}/**/*.${e}`),{restore:!0});return r.src([a,a+"/**/*","!"+a+"/pack.config.js"],{allowEmpty:!0,cwd:Ft}).pipe(qt.if("dev"===Wt,qt.watch([a,a+"/**/*","!/"+a+"/pack.config.js"],{cwd:Ft},(function(e){zt("处理"+e.relative+"......")})))).pipe(qt.filter((function(r){if("project.config.json"!==r.relative&&!function(e){const t=It[Dt.mainMpPath]+"/"+It.subPackagePath;return!c.existsSync(e.path.replace(n.resolve(Ft,t),n.resolve(Ft,Ut)))&&!c.existsSync(e.path.replace(n.resolve(Ft,t),n.resolve(Ft,Kt)))}(r))return!1;if("unlink"===r.event){try{let a=r.path;const s=RegExp(r.extname+"$","i");o.has(r.extname)&&(a=a.replace(s,"."+Dt.css)),l.has(r.extname)&&(a=a.replace(s,"."+Dt.html)),t.sync([a.replace(n.resolve(Ft,e),n.resolve(Ft,Jt))],{force:!0})}catch(e){}return!1}return!0}))).pipe(u).pipe(qt.rename((function(e){e.extname="."+Dt.html}))).pipe(u.restore).pipe(g).pipe(qt.rename((function(e){e.extname="."+Dt.css}))).pipe(g.restore).pipe(f).pipe(qt.replace(/[\s\S]*/,(function(e){return Vt(e)+e}),{skipBinary:!1})).pipe(f.restore).pipe(h).pipe(qt.replace(/[\s\S]*/,Zt(n.resolve(Ft,s)),{skipBinary:!1})).pipe(h.restore).pipe(r.dest(s,{cwd:Ft}))}));const Gt=p(),{cwd:Qt,target:Xt,env:er,projectToSubPackageConfig:tr,basePath:rr,subModePath:nr,targetPath:ar,program:sr,packIsSubpackage:pr,currentNamespace:ir,mpTypeNamespace:or,pluginProcessFileTypes:cr}=E,{writeLastLine:lr}=N,{mixinsEnvCode:ur}=Bt,{runPlugins:gr}=le;r.task("watch:mainWeixinMp",(function(){const e=tr[ir.mainMpPath],a=e+"/"+tr.subPackagePath,s=[],p=[],i=new Set,o=new Set;Object.keys(or).forEach(t=>{s.push(`${e}/**/*.${or[t].css}`),p.push(`${e}/**/*.${or[t].html}`),i.add("."+or[t].css),o.add("."+or[t].html)});const c=Gt.filter([e+"/app.js"],{restore:!0}),l=Gt.filter([e+"/**/*.js"],{restore:!0}),u=Gt.filter([...p],{restore:!0}),g=Gt.filter([...s],{restore:!0}),f=Gt.filter(cr.map(t=>`${e}/**/*.${t}`),{restore:!0});return r.src([e+"/**/*","!"+e+"/app.json","!"+e+"/**/*.json___jb_tmp___","!"+e+`/**/*.${ir.html}___jb_tmp___`,"!"+e+`/**/*.${ir.css}___jb_tmp___`,"!"+e+"/**/*.js___jb_tmp___","!"+a+"/**/*"],{base:n.resolve(Qt,e),allowEmpty:!0,cwd:Qt}).pipe(Gt.if("dev"===er,Gt.watch([e+"/**/*","!/"+e+"/app.json","!/"+a+"/**/*"],{cwd:Qt},(function(e){e.relative.match(/.json/),lr("处理"+e.relative+"......")})))).pipe(Gt.filter((function(r){if("unlink"===r.event){try{let a=r.path;const s=RegExp(r.extname+"$","i");i.has(r.extname)&&(a=a.replace(s,"."+ir.css)),o.has(r.extname)&&(a=a.replace(s,"."+ir.html)),t.sync([a.replace(n.resolve(Qt,e),n.resolve(Qt,Xt))],{force:!0})}catch(e){}return!1}return!0}))).pipe(l).pipe(Gt.replace(/[\s\S]*/,(function(e){return ur(e)+e}),{skipBinary:!1})).pipe(l.restore).pipe(c).pipe(Gt.replace(/^/,(function(e){if(pr.mode||sr.plugin)return"";let t=`./${tr.subPackagePath}/`;if(nr===ar){return fs.readFileSync(rr+"/app.js","utf8")+";\n"}return`require('${t}app.js');\n`}),{skipBinary:!1})).pipe(c.restore).pipe(u).pipe(Gt.rename((function(e){e.extname="."+ir.html}))).pipe(u.restore).pipe(g).pipe(Gt.rename((function(e){e.extname="."+ir.css}))).pipe(g.restore).pipe(f).pipe(Gt.replace(/[\s\S]*/,gr(n.resolve(Qt,Xt+(sr.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(f.restore).pipe(r.dest(Xt+(sr.plugin?"/miniprogram":""),{cwd:Qt}))}));var fr={fakeUniBootstrap:function(e,t,r,n){globalObject.__uniapp2wxpack||(globalObject.__uniapp2wxpack={platform:n}),"alipay"===n&&(n="top");var a=globalObject.__uniapp2wxpack[t.replace("/","")]={__packInit:{}};if(e)for(var s in e)"function"!=typeof e[s]?a.__packInit[s]=e[s]:function(t){a.__packInit[t]=function(){return e[t].apply(e,arguments)}}(s);else e={};if("none"!==r){var p=Page,i=Component,o="",c=1,l=1;"function"==typeof e.onError&&globalObject.onError&&globalObject.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&globalObject.onPageNotFound&&globalObject.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&globalObject.onUnhandledRejection&&globalObject.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),globalObject.onAppRoute&&globalObject.onAppRoute((function(n){"top"!==r&&0!==("/"+n.path).indexOf(t+"/")&&(c=1,e.onHide.call(e,globalObject.getLaunchOptionsSync())),o=n.path})),globalObject.onAppHide((function(){if("top"===r)return e.onHide.call(e,globalObject.getLaunchOptionsSync());var n=getCurrentPages();return 0===("/"+(null==n[n.length-1].route?n[n.length-1].__route__:n[n.length-1].route)).indexOf(t+"/")?(c=1,o="",e.onHide.call(e,globalObject.getLaunchOptionsSync())):void 0})),globalObject.onAppShow((function(){"top"===r&&"function"==typeof e.onShow&&e.onShow.call(e,globalObject.getLaunchOptionsSync()),l&&getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),l=0})),"top"===r&&l&&"function"==typeof e.onLaunch&&e.onLaunch.call(e,globalObject.getLaunchOptionsSync()),Page=function(e){return u(e),p.call(this,e)},Component=function(e){return u(e.methods||{}),i.call(this,e)}}function u(n){if("top"!==r){var a=n.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(n.onShow=function(){var r=getCurrentPages(),n=null==r[r.length-1].route?r[r.length-1].__route__:r[r.length-1].route;if(o&&0===("/"+o).indexOf(t+"/")||0!==("/"+n).indexOf(t+"/")||(c&&(c=0,e.onLaunch.call(e,globalObject.getLaunchOptionsSync())),e.onShow.call(e,globalObject.getLaunchOptionsSync())),"function"==typeof a)return a.apply(this,arguments)})}}},fakeUniBootstrapName:"fakeUniBootstrap"};const hr=p(),{regExpWxResources:mr,regExpUniRequire:dr}=E,{getLevelPath:Pr,getLevel:yr}=N;var vr={uniRequireWxResource:function(){return hr.replace(/[\s\S]*/,(function(e,t){const r=["var __uniPackNativeRequireInject={};\n"],n=yr(this.file.relative);return e=e.replace(dr,(e,t)=>{console.log(`\n编译${e}--\x3erequire(${t.replace(mr,Pr(n))})`);const a=t.replace(mr,Pr(n)),s=`__uniPackNativeRequireInject[${a}] = require(${a});\n`;return 0>r.indexOf(s)&&r.push(s),`__uniPackNativeRequireInject[${a}]`}),r[1]?`${r.join("")} ${e}`:e}),{skipBinary:!1})}};const{currentNamespace:br,regExpWxResources:wr,wxResourceAlias:kr}=E,{getLevelPath:jr,getLevel:xr}=N;var $r=function(e,t){const r=xr(t);return"@import "+`"${kr}/common/main.${br.css}";`.replace(wr,jr(r))+("\n"+e)};const Sr=p(),{fakeUniBootstrapName:_r,fakeUniBootstrap:Er}=fr,{cwd:Or,env:Ar,program:Nr,basePath:Rr,targetPath:Cr,subModePath:Tr,base:Mr,regExpUniRequire:Lr,regExpWxResources:Br,regExpUniImportWxss:qr,currentNamespace:Fr,mpTypeNamespace:Jr,pluginProcessFileTypes:Wr,sourceCodePath:Ir}=E,Ur=process.env.PACK_TYPE,{writeLastLine:Kr,getLevel:Dr,getLevelPath:Yr,deepFind:Hr}=N,{mixinsEnvCode:zr}=Bt,{uniRequireWxResource:Vr}=vr,{runPlugins:Zr}=le,Gr=Object.keys(Jr).map(e=>Jr[e].css),Qr=new Set(Gr);r.task("subMode:createUniSubPackage",(function(){c.mkdirsSync(Rr);const e=Sr.filter(Mr+"/**/*.js",{restore:!0}),a=Sr.filter([Mr+"/common/vendor.js"],{restore:!0}),s=Sr.filter([Mr+"/common/main.js"],{restore:!0}),p=Sr.filter(Wr.map(e=>`${Mr}/**/*.${e}`),{restore:!0}),i=Sr.filter([Mr+"/**/*.js","!"+Mr+"/app.js","!"+Mr+"/common/vendor.js","!"+Mr+"/common/main.js","!"+Mr+"/common/runtime.js"],{restore:!0}),o=Sr.filter([`${Mr}/**/*.${Fr.css}`,`!${Mr}/app.${Fr.css}`,`!${Mr}/common/main.${Fr.css}`],{restore:!0}),l=Sr.filter([`${Mr}/**/*.${Fr.css}`,`!${Mr}/app.${Fr.css}`],{restore:!0}),g=Sr.filter([Mr+"/**/*.json"],{restore:!0}),f=Sr.filter([`${Mr}/**/*.${Fr.html}`],{restore:!0});return r.src([Mr+"/**","!"+Mr+"/*.*",Mr+"/app.js",`${Mr}/app.${Fr.css}`],{allowEmpty:!0,cwd:Or}).pipe(Sr.if("dev"===Ar,Sr.watch([Mr+"/**/*","!/"+Mr+"/*.json"],{cwd:Or},(function(e){Kr("处理"+e.relative+"......")})))).pipe(Sr.filter((function(e){if(function(e){const t=n.resolve(Cr,"app.js"),r=n.resolve(Cr,"app."+Fr.css),a=e.path.replace(Rr,Tr);return t===a||r===a}(e))return!1;if("unlink"===e.event){try{let r=e.path;const a=RegExp(e.extname+"$","i");Qr.has(e.extname.substr(1))&&(r=r.replace(a,"."+Fr.css)),t.sync([r.replace(Rr,n.resolve(Or,Tr))],{force:!0})}catch(e){}return!1}return!0}))).pipe(f).pipe(Sr.replace(/[\s\S]*/,(function(e){const t=this.file.path.replace(RegExp(Fr.html+"$","i"),Fr.css),r=this.file.relative.replace(RegExp(Fr.html+"$","i"),Fr.css);c.existsSync(t)||c.outputFileSync(n.resolve(Or,Tr,r),$r("",r));const a=new F(e);let s=0;return Hr(a.topNode,e=>{if(1===e.type&&"wxs"===e.tag&&1===e.children.length&&3===e.children[0].type){e.children[0].text.replace(Lr,(t,r,n,a)=>{const p=Dr(this.file.relative),i=r.replace(Br,Yr(p)).replace(/['"]/g,"");e.attrsMap.src=i,e.children=[],s=1,console.log(`\n编译${t}--\x3erequire(${i})`)})}}),s?a.render():e}),{skipBinary:!1})).pipe(f.restore).pipe(a).pipe(Sr.replace(/^/,(function(e){return Nr.plugin?`var App=function(packInit){};${Fr.globalObject}.canIUse=function(){return false};`:`var __packConfig=require('../pack.config.js');var App=function(packInit){var ${_r}=${(""+Er).replace(/globalObject/g,Fr.globalObject)};${_r}(packInit,__packConfig.packPath,__packConfig.appMode,'${Ur}');};`}),{skipBinary:!1})).pipe(a.restore).pipe(e).pipe(u()).pipe(Vr()).pipe(Sr.replace(/[\s\S]*/,(function(e){return zr(e)+e}),{skipBinary:!1})).pipe(e.restore).pipe(s).pipe(Sr.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(Sr.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(s.restore).pipe(i).pipe(Sr.replace(/^/,(function(e){if(c.existsSync(n.resolve(Or,Ir,this.file.relative)))return e;return`require('${Yr(Dr(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(i.restore).pipe(g).pipe(Sr.replace(/[\s\S]*/,(function(e){if(!c.existsSync(n.resolve(Or,Ir,this.file.relative.replace(/json$/,"vue")))&&!c.existsSync(n.resolve(Or,Ir,this.file.relative.replace(/json$/,"nvue"))))return e;let t=JSON.parse(""+this.file.contents);for(let e in t.usingComponents)0===t.usingComponents[e].indexOf("/")&&(t.usingComponents[e]=Yr(Dr(this.file.relative))+t.usingComponents[e].replace(/^\//,""));return JSON.stringify(t)}),{skipBinary:!1})).pipe(g.restore).pipe(l).pipe(Sr.stripCssComments()).pipe(Sr.replace(qr,(function(e,t,r){let n="",a=Dr(this.file.relative);return(r+=";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,t){const r=RegExp(`(${Gr.join("|")})(['"])$`);t=t.replace(r,Fr.css+"$2"),n+=`@import ${t.replace(Br,Yr(a))};\n`})),t+n}),{skipBinary:!1})).pipe(l.restore).pipe(o).pipe(Sr.stripCssComments()).pipe(Sr.replace(/^[\s\S]*$/,(function(e){return Tr===Cr?e:$r(e,this.file.relative)}),{skipBinary:!1})).pipe(o.restore).pipe(p).pipe(Sr.replace(/[\s\S]*/,Zr(Tr),{skipBinary:!1})).pipe(p.restore).pipe(r.dest(Tr,{cwd:Or}))}));const Xr=p(),{cwd:en,env:tn,targetPath:rn,subModePath:nn,regExpWxResources:an,regExpUniImportWxss:sn,wxResourcePath:pn,currentNamespace:on,mpTypeNamespace:cn,pluginProcessFileTypes:ln}=E,{writeLastLine:un,getLevel:gn,getLevelPath:fn}=N,{mixinsEnvCode:hn}=Bt,{uniRequireWxResource:mn}=vr,{runPlugins:dn}=le,Pn=[],yn=[],vn=[],bn=new Set,wn=new Set;Object.keys(cn).forEach(e=>{Pn.push(cn[e].css),yn.push(`${pn}/**/*.${cn[e].css}`),vn.push(`${pn}/**/*.${cn[e].html}`),bn.add("."+cn[e].css),wn.add("."+cn[e].html)}),r.task("subMode:copyWxResource",(function(){const e=Xr.filter([pn+"/**/*.js"],{restore:!0}),a=Xr.filter([...yn],{restore:!0}),s=Xr.filter([...vn],{restore:!0}),p=Xr.filter(ln.map(e=>`${pn}/**/*${e}`),{restore:!0});return r.src([pn+"/**",pn],{allowEmpty:!0,cwd:en}).pipe(Xr.if("dev"===tn,Xr.watch([pn+"/**",pn,`!/${pn}/**/*.*___jb_tmp___`],{cwd:en},(function(e){un("处理"+e.relative+"......")})))).pipe(e).pipe(Xr.replace(/[\s\S]*/,(function(e){return hn(e)+e}),{skipBinary:!1})).pipe(Xr.replace(/^/,(function(e){return`require('${fn(gn(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(u()).pipe(mn()).pipe(e.restore).pipe(a).pipe(Xr.stripCssComments()).pipe(Xr.replace(sn,(function(e,t,r){let n="";gn(this.file.relative);return t+n}),{skipBinary:!1})).pipe(Xr.replace(/^[\s\S]*$/,(function(e){return nn===rn?e:$r(e,this.file.relative)}),{skipBinary:!1})).pipe(Xr.rename((function(e){e.extname="."+on.css}))).pipe(a.restore).pipe(s).pipe(Xr.rename((function(e){e.extname="."+on.html}))).pipe(s.restore).pipe(Xr.filter((function(e){if("unlink"===e.event){try{let r=e.path;const a=RegExp(e.extname+"$","i");bn.has(e.extname)&&(r=r.replace(a,"."+on.css)),wn.has(e.extname)&&(r=r.replace(a,"."+on.html)),t.sync([r.replace(n.resolve(en,pn),n.resolve(en,nn))],{force:!0})}catch(e){}return!1}return!0}))).pipe(p).pipe(Xr.replace(/[\s\S]*/,dn(nn),{skipBinary:!1})).pipe(p.restore).pipe(r.dest(nn,{cwd:en}))}));const kn=p(),{cwd:jn,target:xn,env:$n,projectToSubPackageConfig:Sn,currentNamespace:_n,mpTypeNamespace:En,pluginProcessFileTypes:On}=E,{writeLastLine:An}=N,{mixinsEnvCode:Nn}=Bt,{runPlugins:Rn}=le;r.task("watch:native",(function(){const e=Sn[_n.mainMpPath],a=[],s=[],p=new Set,i=new Set;Object.keys(En).forEach(t=>{a.push(`${e}/**/*.${En[t].css}`),s.push(`${e}/**/*.${En[t].html}`),p.add("."+En[t].css),i.add("."+En[t].html)});const o=kn.filter([e+"/**/*.js"],{restore:!0}),c=kn.filter([...s],{restore:!0}),l=kn.filter([...a],{restore:!0}),u=kn.filter(On.map(t=>`${e}/**/*.${t}`),{restore:!0});return r.src([e+"/**/*","!"+e+"/app.json"],{base:n.resolve(jn,e),allowEmpty:!0,cwd:jn}).pipe(kn.if("dev"===$n,kn.watch([e+"/**/*","!/"+e+"/app.json"],{cwd:jn},(function(e){An("处理"+e.relative+"......")})))).pipe(kn.filter((function(r){if("unlink"===r.event){try{let a=r.path;const s=RegExp(r.extname+"$","i");p.has(r.extname)&&(a=a.replace(s,"."+_n.css)),i.has(r.extname)&&(a=a.replace(s,"."+_n.html)),t.sync([a.replace(n.resolve(jn,e),n.resolve(jn,xn))],{force:!0})}catch(e){console.log(e)}return!1}return!0}))).pipe(o).pipe(kn.replace(/[\s\S]*/,(function(e){return Nn(e)+e}),{skipBinary:!1})).pipe(o.restore).pipe(c).pipe(kn.rename((function(e){e.extname="."+_n.html}))).pipe(c.restore).pipe(l).pipe(kn.rename((function(e){e.extname="."+_n.css}))).pipe(l.restore).pipe(u).pipe(kn.replace(/[\s\S]*/,Rn(n.resolve(jn,xn)),{skipBinary:!1})).pipe(u.restore).pipe(r.dest(xn,{cwd:jn}))}));const{cwd:Cn,env:Tn,targetPath:Mn,subModePath:Ln,projectToSubPackageConfig:Bn,program:qn,currentNamespace:Fn}=E,{tryAgain:Jn}=N;async function Wn(e){let t=n.resolve(Cn,Bn[Fn.mainMpPath],"app.js");await c.exists(t)||await c.outputFile(t,"App({});"),e()}r.task("mpWxSubMode",r.series((function(e){console.log("小程序解耦构建开启，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(t){if(qn.plugin||qn.native)t();else{try{let e={packPath:(Bn.subPackagePath?"/":"")+Bn.subPackagePath,appMode:Bn.appMode};await c.outputFile(Ln+"/pack.config.js","module.exports="+JSON.stringify(e,null,4))}catch(r){return void await Jn(async()=>{await e(t)})}t()}}),function(){let e=[Wn,"subMode:createUniSubPackage","subMode:copyWxResource",...qn.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...Bn.mergePack?["watch:mainWeixinMpPackPath"]:[],...Ln===Mn?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return qn.native&&(e=[Wn,"watch:mainAppJson","watch:native"]),"build"===Tn?r.series.apply(this,e):r.parallel.apply(this,e)}(),(function(e){e(),"build"===Tn&&process.exit()})));const{cwd:In,basePath:Un,base:Kn,program:Dn}=E;r.task("startToPackServe",r.series((async function(e){Dn.native||await c.exists(Un)||await c.mkdirs(Un),e()}),"clean:base",(function(e){Dn.native?e():r.watch(Kn+"/app.json",{events:["all"],cwd:In},(function(){e()}))}),"mpWxSubMode")),process.on("unhandledRejection",()=>{});
