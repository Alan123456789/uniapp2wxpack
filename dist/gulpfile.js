"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("del")),n=e(require("gulp")),r=e(require("path")),a=e(require("commander")),s=e(require("single-line-log")),p=e(require("gulp-load-plugins")),i=e(require("vue-template-compiler")),o=e(require("preprocess")),c=e(require("fs-extra")),l=e(require("strip-json-comments")),u=e(require("gulp-strip-comments"));const{program:g}=a;g.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式").option("--type <type>","解耦包类型(哪种小程序)","weixin").option("--native","原生模式"),g.parse(process.argv);const f={weixin:{html:"wxml",css:"wxss",globalObject:"wx",mainMpPath:"mainWeixinMpPath",directivePrefix:"wx:",projectConfig:"project.config.json"},baidu:{html:"swan",css:"css",globalObject:"swan",mainMpPath:"mainBaiduMpPath",directivePrefix:"s-",projectConfig:"project.swan.json"},toutiao:{html:"ttml",css:"ttss",globalObject:"tt",mainMpPath:"mainToutiaoMpPath",directivePrefix:"tt:",projectConfig:"project.config.json"},alipay:{html:"axml",css:"acss",globalObject:"my",mainMpPath:"mainAlipayMpPath",directivePrefix:"a:",projectConfig:"mini.project.json"}},h=f[g.type];if(!h)throw Error("小程序类型错");process.env.PACK_TYPE=g.type;const m=g.scope,d=function(){return require.apply(null,arguments)}(r.resolve(m,"./projectToSubPackageConfig")),P=d.sourceCodePath||"src",y=d.wxResourcePath||`${P}/${h.globalObject}resource`,b=d.wxResourceAlias||"@wxResource",v=RegExp(b+"\\/","g"),w=d.uniRequireApiName||"__uniRequireWx",j=RegExp(w+"\\(([a-zA-Z.\\/\"'@\\d-_]+)\\)","g"),k=d.uniImportWxssApiName||"__uniWxss",x=RegExp(`(}|^|\\s|;)${k}\\s*{([^{}]+)}`,"g");let $="dev";"production"===process.env.NODE_ENV&&($="build");const S="dist/"+$+"/mp-"+g.type;let O="dist/"+$+`/mp-${g.type}-pack`;g.plugin&&(O="dist/"+$+`/mp-${g.type}-pack-plugin`);var _={pluginProcessFileTypes:d.pluginProcessFileTypes||["js","json","wxml","ttml","ttss","swan","css","html","wxss","htm","wxs","sjs","acss","axml"],currentNamespace:h,program:g,cwd:m,projectToSubPackageConfig:d,wxResourcePath:y,wxResourceAlias:b,regExpWxResources:v,uniRequireApiName:w,regExpUniRequire:j,uniImportWxssApiName:k,regExpUniImportWxss:x,configWxResourceKey:d.configWxResourceKey||"wxResource",env:$,base:S,target:O,basePath:r.resolve(m,S),subModePath:r.resolve(m,O,d.subPackagePath),targetPath:r.resolve(m,O),packIsSubpackage:{mode:!1},mpTypeNamespace:f,sourceCodePath:P};let E;const C=s.stdout;var A={tryAgain:async function(e){return new Promise(async t=>{setTimeout(async()=>{t(await e())},100)})},getLevelPath:function(e){return Array(e).fill("../").join("")},getLevel:function(e){return e.split(/[\\/]/).length-1},writeLastLine:function(e){C(e),clearTimeout(E),E=setTimeout(()=>{C("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)},deepFind:function e(t,n,r,a){n&&(n(t,r,a),t.childNodes?t.childNodes.forEach((t,r,a)=>{e(t,n,r,a)}):t.children&&t.children.forEach((t,r,a)=>{e(t,n,r,a)}))}};const{basePath:N}=_,{tryAgain:R}=A;n.task("clean:base",(async function e(n){try{await t([N+"/**/*"],{force:!0})}catch(t){return void await R(async()=>{await e(n)})}n()}));const{subModePath:M}=_,{tryAgain:T}=A;n.task("clean:subModePath",(async function e(n){try{await t([M+"/**/*"],{force:!0})}catch(t){return void await T(async()=>{await e(n)})}n()}));const{targetPath:L}=_,{tryAgain:B}=A;n.task("clean:previewDist",(async function e(n){try{await t([L+"/**/*"],{force:!0})}catch(t){return void await B(async()=>{await e(n)})}n()}));const{compile:q}=i;var F=class{constructor(e){this.topNode={children:[]},this.init(e)}init(e){this.topNode=q(`<div>${e}</div>`).ast}getAttr(e,t){return e.attrsMap&&e.attrsMap[t]||""}setAttr(e,t,n){if(!e.attrsMap)return"";e.attrsMap[t]=n}render(e=this.topNode.children,t=""){return e.reduce((e,t)=>{if(t.removed)return e;if(1===t.type&&!t.tag)return e;if(3===t.type||2===t.type)return e+=this.writeText(t);const{tag:n,attrsMap:r,children:a=[]}=t;return e+=this.writeOpenTag(n,r),e+=this.render(a),e+=this.writeCloseTag(n)},t)}writeOpenTag(e,t){if(t){const n=Object.keys(t).map(e=>t[e].indexOf('"')>-1&&0>t[e].indexOf("'")?`${e}='${t[e]}'`:`${e}="${t[e]}"`);return`<${e}${n.length>0?" "+n.join(" "):""}>`}return`<${e}>`}writeText(e){return e.text}writeCloseTag(e){return`</${e}>`}};const{currentNamespace:J,mpTypeNamespace:W}=_,{deepFind:I}=A,U=Object.keys(W).map(e=>W[e].directivePrefix),K=Object.keys(W).map(e=>W[e].html),D=RegExp(`^(${U.join("|")})`),H=RegExp(`\\.(${K.join("|")})$`,"i");var Y=function(e,t){if(t.relative.match(H)){const t=new F(e);return I(t.topNode,e=>{if(!e.tag||3===e.type)return;const n=t.getAttr(e,"class");"toutiao"===process.env.PACK_TYPE&&n&&!n.match(/(^\s|(\s$))/)&&t.setAttr(e,"class",n+" ");const r=t.getAttr(e,"catchTap");"toutiao"===process.env.PACK_TYPE&&r&&!t.getAttr(e,"bindTap")&&t.setAttr(e,"bindTap",r);const a=t.getAttr(e,"src");e.tag.match(/^(include|import)$/)&&a&&t.setAttr(e,"src",a.replace(H,"."+J.html)),e.attrsMap&&Object.keys(e.attrsMap).forEach(t=>{if(t.match(D)){const n=t.replace(D,J.directivePrefix);e.attrsMap[n]=e.attrsMap[t],n!==t&&delete e.attrsMap[t]}})}),t.render()}return e};const{currentNamespace:z,mpTypeNamespace:V}=_,Z=Object.keys(V).map(e=>V[e].css),G=RegExp(`\\.(${Z.join("|")})$`,"i");var Q=function(e,{relative:t}){return t.match(G)&&(e=e.replace(/@import\s*['"](\S+)['"]/g,(function(e,t){return`@import '${t.replace(G,"."+z.css)}'`}))),e};var X=function(e,{relative:t}){return"toutiao"===process.env.PACK_TYPE&&t.match(/^\/app.js$/i)?"\nif (!Promise.prototype.finally) {\n    Promise.prototype.finally = function (callback) {\n        let P = this.constructor;\n        return this.then(\n            value  => P.resolve(callback()).then(() => value),\n            reason => P.resolve(callback()).then(() => { throw reason })\n        );\n    };\n}\n;\n"+e:e};const{preprocess:ee}=o;var te=function(e,{relative:t}){if(t.match(/.js$/i))try{return ee(e,process.env,{type:"js"})}catch(t){return console.log("js条件编译出错"),console.log(t),e}return e};const{currentNamespace:ne}=_,{preprocess:re}=o;var ae=function(e,{relative:t}){if(t.match(RegExp(`.${ne.css}$`,"i")))try{return re(e,process.env,{type:"css"})}catch(t){return console.log(ne.css+"条件编译出错"),console.log(t),e}return e};const{currentNamespace:se}=_,{preprocess:pe}=o;var ie={htmlMixinPlugin:Y,cssMixinPlugin:Q,polyfillPlugin:X,jsPreProcessPlugin:te,cssPreProcessPlugin:ae,htmlPreProcessPlugin:function(e,{relative:t}){if(t.match(RegExp(`.${se.html}$`,"i")))try{return pe(e,process.env,{type:"html"})}catch(t){return console.log(se.html+"条件编译出错"),console.log(t),e}return e}};const{projectToSubPackageConfig:oe,targetPath:ce}=_;(!oe.plugins||!oe.plugins instanceof Array)&&(oe.plugins=[]);var le={runPlugins:function(e){return function(t){const{plugins:n}=oe;if(!n||!n instanceof Array)return;const a=r.resolve(e,this.file.relative),s={relative:a.replace(RegExp("^"+ce.replace(/\\/g,"\\\\")),"").replace(/\\/g,"/"),absolute:a};return n.reduce((e,t)=>{if("string"==typeof t&&(t=ie[t]),"function"!=typeof t)return e;const n=t(e,s,ie);return null==n?e:n},t)}}};const ue=p(),{cwd:ge,projectToSubPackageConfig:fe,target:he,env:me,pluginProcessFileTypes:de,sourceCodePath:Pe}=_,{writeLastLine:ye}=A,{runPlugins:be}=le;n.task("watch:pluginJson",(function(){const e=ue.filter(de.map(e=>"/**/*."+e),{restore:!0});return n.src(Pe+"/plugin.json",{allowEmpty:!0,cwd:ge}).pipe(ue.if("dev"===me,ue.watch(Pe+"/plugin.json",{cwd:ge},(function(e){ye("处理"+e.relative+"......")})))).pipe(e).pipe(ue.replace(/[\s\S]*/,be(r.resolve(ge,he+"/"+fe.subPackagePath)),{skipBinary:!1})).pipe(e.restore).pipe(n.dest(he+"/"+fe.subPackagePath,{cwd:ge}))}));const ve=p(),{cwd:we,target:je,env:ke,targetPath:xe,pluginProcessFileTypes:$e,currentNamespace:Se}=_,{writeLastLine:Oe}=A,{runPlugins:_e}=le;n.task("watch:projectConfigJson",(function(){const e=ve.filter($e.map(e=>"/**/*."+e),{restore:!0});return n.src(Se.projectConfig,{allowEmpty:!0,cwd:we}).pipe(ve.if("dev"===ke,ve.watch(Se.projectConfig,{cwd:we},(function(e){Oe("处理"+e.relative+"......")})))).pipe(e).pipe(ve.replace(/[\s\S]*/,_e(xe),{skipBinary:!1})).pipe(e.restore).pipe(n.dest(je,{cwd:we}))}));const{program:Ee,cwd:Ce,projectToSubPackageConfig:Ae,basePath:Ne,subModePath:Re,targetPath:Me,packIsSubpackage:Te,currentNamespace:Le}=_;var Be=function(){if(Ee.plugin)return;const e=r.resolve(Ce,Ae[Le.mainMpPath]+"/app.js");if(c.existsSync(e)){const t=c.readFileSync(e,"utf8");let n=`require('${`./${Ae.subPackagePath}/`}app.js');\n`;if(Re===Me){n=c.readFileSync(Ne+"/app.js","utf8")+";\n"}(Te.mode||Ee.plugin)&&(n=""),c.outputFileSync(Me+"/app.js",n+t)}};const qe=p(),{program:Fe,cwd:Je,projectToSubPackageConfig:We,configWxResourceKey:Ie,base:Ue,packIsSubpackage:Ke,currentNamespace:De,sourceCodePath:He}=_,{writeLastLine:Ye}=A;var ze=function(e){return Ye("处理app.json......"),qe.replace(/[\s\S]+/,(function(t){if(Fe.plugin&&"mainAppJson"===e)return t;Ke.mode=!1;let n,a,s,p={};({pagesJson(){try{n=JSON.parse(l(t))}catch(e){n={}}},baseAppJson(){try{a=JSON.parse(t)}catch(e){a={}}},mainAppJson(){try{s=JSON.parse(t)}catch(e){s={}}}})[e]();try{n||(n=JSON.parse(l(c.readFileSync(r.resolve(Je,He+"/pages.json"),"utf8"))))}catch(e){n={}}try{a||(a=JSON.parse(c.readFileSync(r.resolve(Je,Ue+"/app.json"),"utf8")))}catch(e){a={}}try{s||(s=JSON.parse(c.readFileSync(r.resolve(Je,We[De.mainMpPath]+"/app.json"),"utf8")))}catch(e){s={}}function i(e){return We.subPackagePath+(We.subPackagePath?"/":"")+e}if(s.subPackages){let e=s.subPackages.find(e=>e.root===We.subPackagePath);if(e){Ke.mode=!0;let t=[...n[Ie]&&n[Ie].pages||[],...a.pages||[]];return a.subPackages&&a.subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),n[Ie]&&n[Ie].subPackages&&n[Ie].subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),e.pages=t,Be(),delete a.pages,delete a.subPackages,JSON.stringify({...a,...s},null,2)}}a.pages&&a.pages.forEach((e,t)=>{a.pages[t]=i(e)}),a.subPackages&&a.subPackages.forEach(e=>{e.root=i(e.root)}),n[Ie]&&(n[Ie].pages&&n[Ie].pages.forEach((e,t)=>{n[Ie].pages[t]=i(e)}),n[Ie].subPackages&&n[Ie].subPackages.forEach(e=>{e.root=i(e.root)})),a.tabBar&&a.tabBar.list&&a.tabBar.list.forEach(({pagePath:e,iconPath:t,selectedIconPath:n,...r},s)=>{a.tabBar.list[s]={pagePath:e?i(e):"",iconPath:t?i(t):"",selectedIconPath:n?i(n):"",...r}}),p={...a,...s},p.pages=Array.from(new Set([...n.indexPage?[i(n.indexPage)]:[],...s.pages||[],...a.pages||[],...n[Ie]&&n[Ie].pages||[]]));let o=[],u={};function g(e){e.forEach(e=>{u[e.root]=u[e.root]?Array.from(new Set([...u[e.root],...e.pages])):e.pages})}g(n[Ie]&&n[Ie].subPackages||[]),g(a.subPackages||[]),g(s.subPackages||[]);for(let e in u)o.push({root:e,pages:u[e]});if(p.subPackages=[...o],a.usingComponents){for(let e in a.usingComponents)a.usingComponents[e]="/"+We.subPackagePath+a.usingComponents[e];p.usingComponents={...p.usingComponents||{},...a.usingComponents}}return Be(),"toutiao"===Fe.type&&p.subPackages&&(p.subPackages.forEach(e=>{e.pages.forEach(t=>{p.pages.push((e.root+"/"+t).replace(/\/\//g,"/"))})}),delete p.subPackages),JSON.stringify(p,null,2)}),{skipBinary:!1})};const Ve=p(),{cwd:Ze,target:Ge,env:Qe,targetPath:Xe,pluginProcessFileTypes:et,sourceCodePath:tt}=_,{writeLastLine:nt}=A,{runPlugins:rt}=le;n.task("watch:pagesJson",(function(){const e=Ve.filter(et.map(e=>"/**/*."+e),{restore:!0});return n.src(tt+"/pages.json",{allowEmpty:!0,cwd:Ze}).pipe(Ve.if("dev"===Qe,Ve.watch(tt+"/pages.json",{cwd:Ze},(function(e){nt("处理"+e.relative+"......")})))).pipe(ze("pagesJson")).pipe(Ve.rename("app.json")).pipe(e).pipe(Ve.replace(/[\s\S]*/,rt(Xe),{skipBinary:!1})).pipe(e.restore).pipe(n.dest(Ge,{cwd:Ze}))}));const at=p(),{cwd:st,target:pt,env:it,base:ot,targetPath:ct,pluginProcessFileTypes:lt}=_,{writeLastLine:ut}=A,{runPlugins:gt}=le;n.task("watch:baseAppJson",(function(){const e=at.filter(lt.map(e=>`${ot}/**/*.${e}`),{restore:!0});return n.src(ot+"/app.json",{allowEmpty:!0,cwd:st}).pipe(at.if("dev"===it,at.watch(ot+"/app.json",{cwd:st},(function(e){ut("处理"+e.relative+"......")})))).pipe(ze("baseAppJson")).pipe(e).pipe(at.replace(/[\s\S]*/,gt(ct),{skipBinary:!1})).pipe(e.restore).pipe(n.dest(pt,{cwd:st}))}));const ft=p(),{cwd:ht,target:mt,env:dt,projectToSubPackageConfig:Pt,program:yt,currentNamespace:bt,pluginProcessFileTypes:vt}=_,{writeLastLine:wt}=A,{runPlugins:jt}=le;n.task("watch:mainAppJson",(function(){const e=Pt[bt.mainMpPath],t=ft.filter(vt.map(t=>`${e}/**/*.${t}`),{restore:!0});return n.src(e+"/app.json",{allowEmpty:!0,cwd:ht}).pipe(ft.if("dev"===dt,ft.watch(e+"/app.json",{cwd:ht},(function(e){wt("处理"+e.relative+"......")})))).pipe(ze("mainAppJson")).pipe(t).pipe(ft.replace(/[\s\S]*/,jt(r.resolve(ht,mt+(yt.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(t.restore).pipe(n.dest(mt+(yt.plugin?"/miniprogram":""),{cwd:ht}))}));const kt=p(),{cwd:xt,target:$t,env:St,projectToSubPackageConfig:Ot,program:_t,basePath:Et,currentNamespace:Ct,mpTypeNamespace:At,pluginProcessFileTypes:Nt}=_,{writeLastLine:Rt}=A,{runPlugins:Mt}=le;n.task("watch:topMode-mainAppJsAndAppWxss",(function(){let e=Ot[Ct.mainMpPath];const t=Object.keys(At).map(t=>`${e}/app.${At[t].css}`),a=kt.filter([...t],{restore:!0}),s=kt.filter([e+"/app.js"],{restore:!0}),p=kt.filter(Nt.map(t=>`${e}/**/*.${t}`),{restore:!0});return n.src([e+"/app.js",...t],{allowEmpty:!0,cwd:xt}).pipe(kt.if("dev"===St,kt.watch([e+"/app.js",`${e}/app.${Ct.css}`],{cwd:xt},(function(e){Rt("处理"+e.relative+"......")})))).pipe(s).pipe(kt.replace(/^/,(function(e){return c.readFileSync(Et+"/app.js","utf8")+";\n"}),{skipBinary:!1})).pipe(s.restore).pipe(a).pipe(kt.replace(/^/,(function(e){return c.readFileSync(`${Et}/app.${Ct.css}`,"utf8")+"\n"}),{skipBinary:!1})).pipe(kt.rename((function(e){e.extname="."+Ct.css}))).pipe(a.restore).pipe(p).pipe(kt.replace(/[\s\S]*/,Mt(r.resolve(xt,$t+(_t.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(p.restore).pipe(n.dest($t+(_t.plugin?"/miniprogram":""),{cwd:xt}))}));const{mpTypeNamespace:Tt,currentNamespace:Lt}=_,Bt=(process,new Set(Object.keys(Tt).map(e=>Tt[e].globalObject)));var qt={mixinsEnvCode:function(e){let t="";return Bt.forEach(e=>{Lt.globalObject!==e&&(t+=`var ${e} = ${Lt.globalObject};\n`)}),t}};const Ft=p(),{cwd:Jt,target:Wt,env:It,projectToSubPackageConfig:Ut,base:Kt,wxResourcePath:Dt,currentNamespace:Ht,mpTypeNamespace:Yt,pluginProcessFileTypes:zt}=_,{writeLastLine:Vt}=A,{mixinsEnvCode:Zt}=qt,{runPlugins:Gt}=le;n.task("watch:mainWeixinMpPackPath",(function(){const e=Ut[Ht.mainMpPath],a=e+"/"+Ut.subPackagePath,s=Wt+"/"+Ut.subPackagePath,p=[],i=[],o=new Set,l=new Set;Object.keys(Yt).forEach(e=>{p.push(`${a}/**/*.${Yt[e].css}`),i.push(`${a}/**/*.${Yt[e].html}`),o.add("."+Yt[e].css),l.add("."+Yt[e].html)});const u=Ft.filter([...i],{restore:!0}),g=Ft.filter([...p],{restore:!0}),f=Ft.filter([a+"/**/*.js"],{restore:!0}),h=Ft.filter(zt.map(e=>`${a}/**/*.${e}`),{restore:!0});return n.src([a,a+"/**/*","!"+a+"/pack.config.js"],{allowEmpty:!0,cwd:Jt}).pipe(Ft.if("dev"===It,Ft.watch([a,a+"/**/*","!/"+a+"/pack.config.js"],{cwd:Jt},(function(e){Vt("处理"+e.relative+"......")})))).pipe(Ft.filter((function(n){if(n.relative!==Ht.projectConfig&&!function(e){const t=Ut[Ht.mainMpPath]+"/"+Ut.subPackagePath;return!c.existsSync(e.path.replace(r.resolve(Jt,t),r.resolve(Jt,Kt)))&&!c.existsSync(e.path.replace(r.resolve(Jt,t),r.resolve(Jt,Dt)))}(n))return!1;if("unlink"===n.event){try{let a=n.path;const s=RegExp(n.extname+"$","i");o.has(n.extname)&&(a=a.replace(s,"."+Ht.css)),l.has(n.extname)&&(a=a.replace(s,"."+Ht.html)),t.sync([a.replace(r.resolve(Jt,e),r.resolve(Jt,Wt))],{force:!0})}catch(e){}return!1}return!0}))).pipe(u).pipe(Ft.rename((function(e){e.extname="."+Ht.html}))).pipe(u.restore).pipe(g).pipe(Ft.rename((function(e){e.extname="."+Ht.css}))).pipe(g.restore).pipe(f).pipe(Ft.replace(/[\s\S]*/,(function(e){return Zt(e)+e}),{skipBinary:!1})).pipe(f.restore).pipe(h).pipe(Ft.replace(/[\s\S]*/,Gt(r.resolve(Jt,s)),{skipBinary:!1})).pipe(h.restore).pipe(n.dest(s,{cwd:Jt}))}));const Qt=p(),{cwd:Xt,target:en,env:tn,projectToSubPackageConfig:nn,basePath:rn,subModePath:an,targetPath:sn,program:pn,packIsSubpackage:on,currentNamespace:cn,mpTypeNamespace:ln,pluginProcessFileTypes:un}=_,{writeLastLine:gn}=A,{mixinsEnvCode:fn}=qt,{runPlugins:hn}=le;n.task("watch:mainWeixinMp",(function(){const e=nn[cn.mainMpPath],a=e+"/"+nn.subPackagePath,s=[],p=[],i=new Set,o=new Set;Object.keys(ln).forEach(t=>{s.push(`${e}/**/*.${ln[t].css}`),p.push(`${e}/**/*.${ln[t].html}`),i.add("."+ln[t].css),o.add("."+ln[t].html)});const c=Qt.filter([e+"/app.js"],{restore:!0}),l=Qt.filter([e+"/**/*.js"],{restore:!0}),u=Qt.filter([...p],{restore:!0}),g=Qt.filter([...s],{restore:!0}),f=Qt.filter(un.map(t=>`${e}/**/*.${t}`),{restore:!0});return n.src([e+"/**/*","!"+e+"/app.json","!"+e+"/**/*.json___jb_tmp___","!"+e+`/**/*.${cn.html}___jb_tmp___`,"!"+e+`/**/*.${cn.css}___jb_tmp___`,"!"+e+"/**/*.js___jb_tmp___","!"+a+"/**/*"],{base:r.resolve(Xt,e),allowEmpty:!0,cwd:Xt}).pipe(Qt.if("dev"===tn,Qt.watch([e+"/**/*","!/"+e+"/app.json","!/"+a+"/**/*"],{cwd:Xt},(function(e){e.relative.match(/.json/),gn("处理"+e.relative+"......")})))).pipe(Qt.filter((function(n){if("unlink"===n.event){try{let a=n.path;const s=RegExp(n.extname+"$","i");i.has(n.extname)&&(a=a.replace(s,"."+cn.css)),o.has(n.extname)&&(a=a.replace(s,"."+cn.html)),t.sync([a.replace(r.resolve(Xt,e),r.resolve(Xt,en))],{force:!0})}catch(e){}return!1}return!0}))).pipe(l).pipe(Qt.replace(/[\s\S]*/,(function(e){return fn(e)+e}),{skipBinary:!1})).pipe(l.restore).pipe(c).pipe(Qt.replace(/^/,(function(e){if(on.mode||pn.plugin)return"";let t=`./${nn.subPackagePath}/`;if(an===sn){return fs.readFileSync(rn+"/app.js","utf8")+";\n"}return`require('${t}app.js');\n`}),{skipBinary:!1})).pipe(c.restore).pipe(u).pipe(Qt.rename((function(e){e.extname="."+cn.html}))).pipe(u.restore).pipe(g).pipe(Qt.rename((function(e){e.extname="."+cn.css}))).pipe(g.restore).pipe(f).pipe(Qt.replace(/[\s\S]*/,hn(r.resolve(Xt,en+(pn.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(f.restore).pipe(n.dest(en+(pn.plugin?"/miniprogram":""),{cwd:Xt}))}));var mn={fakeUniBootstrap:function(e,t,n,r){globalObject.__uniapp2wxpack||(globalObject.__uniapp2wxpack={platform:r}),"relegation"!==n||globalObject.onAppRoute||(globalObject.onAppHide&&globalObject.onAppShow?(n="top",console.warn("uniapp2wxpack warn: ide不支持appMode设为relegation，但是支持top，所以转为top")):(n="none",console.warn("uniapp2wxpack warn: ide不支持appMode设为relegation和top，所以转为none")));var a=globalObject.__uniapp2wxpack[t.replace("/","")]={__packInit:{}};if(e)for(var s in e)"function"!=typeof e[s]?a.__packInit[s]=e[s]:function(t){a.__packInit[t]=function(){return e[t].apply(e,arguments)}}(s);else e={};if("none"!==n){var p=Page,i=Component,o="",c=1,l=1;"function"==typeof e.onError&&globalObject.onError&&globalObject.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&globalObject.onPageNotFound&&globalObject.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&globalObject.onUnhandledRejection&&globalObject.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),globalObject.onAppRoute&&globalObject.onAppRoute((function(r){"top"!==n&&0!==("/"+r.path).indexOf(t+"/")&&(c=1,e.onHide.call(e,globalObject.getLaunchOptionsSync())),o=r.path})),globalObject.onAppHide((function(r){if("top"===n)return globalObject.getLaunchOptionsSync?e.onHide.call(e,globalObject.getLaunchOptionsSync()):e.onHide.call(e,r);var a=getCurrentPages();return 0===("/"+(null==a[a.length-1].route?a[a.length-1].__route__:a[a.length-1].route)).indexOf(t+"/")?(c=1,o="",e.onHide.call(e,globalObject.getLaunchOptionsSync())):void 0})),globalObject.onAppShow((function(t){if("top"===n&&"function"==typeof e.onShow)return globalObject.getLaunchOptionsSync?e.onShow.call(e,globalObject.getLaunchOptionsSync()):e.onShow.call(e,t);l&&getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),l=0})),"top"===n&&l&&"function"==typeof e.onLaunch&&globalObject.getLaunchOptionsSync&&e.onLaunch.call(e,globalObject.getLaunchOptionsSync()),Page=function(e){return u(e),p.call(this,e)},Component=function(e){return u(e.methods||{}),i.call(this,e)}}function u(r){if("top"!==n){var a=r.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(r.onShow=function(){var n=getCurrentPages(),r=null==n[n.length-1].route?n[n.length-1].__route__:n[n.length-1].route;if(o&&0===("/"+o).indexOf(t+"/")||0!==("/"+r).indexOf(t+"/")||(c&&(c=0,e.onLaunch.call(e,globalObject.getLaunchOptionsSync())),e.onShow.call(e,globalObject.getLaunchOptionsSync())),"function"==typeof a)return a.apply(this,arguments)})}}},fakeUniBootstrapName:"fakeUniBootstrap"};const dn=p(),{regExpWxResources:Pn,regExpUniRequire:yn}=_,{getLevelPath:bn,getLevel:vn}=A;var wn={uniRequireWxResource:function(){return dn.replace(/[\s\S]*/,(function(e,t){const n=["var __uniPackNativeRequireInject={};\n"],r=vn(this.file.relative);return e=e.replace(yn,(e,t)=>{console.log(`\n编译${e}--\x3erequire(${t.replace(Pn,bn(r))})`);const a=t.replace(Pn,bn(r)),s=`__uniPackNativeRequireInject[${a}] = require(${a});\n`;return 0>n.indexOf(s)&&n.push(s),`__uniPackNativeRequireInject[${a}]`}),n[1]?`${n.join("")} ${e}`:e}),{skipBinary:!1})}};const{currentNamespace:jn,regExpWxResources:kn,wxResourceAlias:xn}=_,{getLevelPath:$n,getLevel:Sn}=A;var On=function(e,t){const n=Sn(t);return"@import "+`"${xn}/common/main.${jn.css}";`.replace(kn,$n(n))+("\n"+e)};const _n=p(),{fakeUniBootstrapName:En,fakeUniBootstrap:Cn}=mn,{cwd:An,env:Nn,program:Rn,basePath:Mn,targetPath:Tn,subModePath:Ln,base:Bn,regExpUniRequire:qn,regExpWxResources:Fn,regExpUniImportWxss:Jn,currentNamespace:Wn,mpTypeNamespace:In,pluginProcessFileTypes:Un,sourceCodePath:Kn}=_,Dn=process.env.PACK_TYPE,{writeLastLine:Hn,getLevel:Yn,getLevelPath:zn,deepFind:Vn}=A,{mixinsEnvCode:Zn}=qt,{uniRequireWxResource:Gn}=wn,{runPlugins:Qn}=le,Xn=Object.keys(In).map(e=>In[e].css),er=new Set(Xn);n.task("subMode:createUniSubPackage",(function(){c.mkdirsSync(Mn);const e=_n.filter(Bn+"/**/*.js",{restore:!0}),a=_n.filter([Bn+"/common/vendor.js"],{restore:!0}),s=_n.filter([Bn+"/common/main.js"],{restore:!0}),p=_n.filter(Un.map(e=>`${Bn}/**/*.${e}`),{restore:!0}),i=_n.filter([Bn+"/**/*.js","!"+Bn+"/app.js","!"+Bn+"/common/vendor.js","!"+Bn+"/common/main.js","!"+Bn+"/common/runtime.js"],{restore:!0}),o=_n.filter([`${Bn}/**/*.${Wn.css}`,`!${Bn}/app.${Wn.css}`,`!${Bn}/common/main.${Wn.css}`],{restore:!0}),l=_n.filter([`${Bn}/**/*.${Wn.css}`,`!${Bn}/app.${Wn.css}`],{restore:!0}),g=_n.filter([Bn+"/**/*.json"],{restore:!0}),f=_n.filter([`${Bn}/**/*.${Wn.html}`],{restore:!0});return n.src([Bn+"/**","!"+Bn+"/*.*",Bn+"/app.js",`${Bn}/app.${Wn.css}`],{allowEmpty:!0,cwd:An}).pipe(_n.if("dev"===Nn,_n.watch([Bn+"/**/*","!/"+Bn+"/*.json"],{cwd:An},(function(e){Hn("处理"+e.relative+"......")})))).pipe(_n.filter((function(e){if(function(e){const t=r.resolve(Tn,"app.js"),n=r.resolve(Tn,"app."+Wn.css),a=e.path.replace(Mn,Ln);return t===a||n===a}(e))return!1;if("unlink"===e.event){try{let n=e.path;const a=RegExp(e.extname+"$","i");er.has(e.extname.substr(1))&&(n=n.replace(a,"."+Wn.css)),t.sync([n.replace(Mn,r.resolve(An,Ln))],{force:!0})}catch(e){}return!1}return!0}))).pipe(f).pipe(_n.replace(/[\s\S]*/,(function(e){const t=this.file.path.replace(RegExp(Wn.html+"$","i"),Wn.css),n=this.file.relative.replace(RegExp(Wn.html+"$","i"),Wn.css);c.existsSync(t)||c.outputFileSync(r.resolve(An,Ln,n),On("",n));const a=new F(e);let s=0;return Vn(a.topNode,e=>{if(1===e.type&&"wxs"===e.tag&&1===e.children.length&&3===e.children[0].type){e.children[0].text.replace(qn,(t,n,r,a)=>{const p=Yn(this.file.relative),i=n.replace(Fn,zn(p)).replace(/['"]/g,"");e.attrsMap.src=i,e.children=[],s=1,console.log(`\n编译${t}--\x3erequire(${i})`)})}}),s?a.render():e}),{skipBinary:!1})).pipe(f.restore).pipe(a).pipe(_n.replace(/^/,(function(e){return Rn.plugin?`var App=function(packInit){};${Wn.globalObject}.canIUse=function(){return false};`:`var __packConfig=require('../pack.config.js');var App=function(packInit){var ${En}=${(""+Cn).replace(/globalObject/g,Wn.globalObject)};${En}(packInit,__packConfig.packPath,__packConfig.appMode,'${Dn}');};`}),{skipBinary:!1})).pipe(a.restore).pipe(e).pipe(u()).pipe(Gn()).pipe(_n.replace(/[\s\S]*/,(function(e){return Zn(e)+e}),{skipBinary:!1})).pipe(e.restore).pipe(s).pipe(_n.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(_n.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(s.restore).pipe(i).pipe(_n.replace(/^/,(function(e){if(c.existsSync(r.resolve(An,Kn,this.file.relative)))return e;return`require('${zn(Yn(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(i.restore).pipe(g).pipe(_n.replace(/[\s\S]*/,(function(e){if(!c.existsSync(r.resolve(An,Kn,this.file.relative.replace(/json$/,"vue")))&&!c.existsSync(r.resolve(An,Kn,this.file.relative.replace(/json$/,"nvue"))))return e;let t=JSON.parse(""+this.file.contents);for(let e in t.usingComponents)0===t.usingComponents[e].indexOf("/")&&(t.usingComponents[e]=zn(Yn(this.file.relative))+t.usingComponents[e].replace(/^\//,""));return JSON.stringify(t)}),{skipBinary:!1})).pipe(g.restore).pipe(l).pipe(_n.stripCssComments()).pipe(_n.replace(Jn,(function(e,t,n){let r="",a=Yn(this.file.relative);return(n+=";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,t){const n=RegExp(`(${Xn.join("|")})(['"])$`);t=t.replace(n,Wn.css+"$2"),r+=`@import ${t.replace(Fn,zn(a))};\n`})),t+r}),{skipBinary:!1})).pipe(l.restore).pipe(o).pipe(_n.stripCssComments()).pipe(_n.replace(/^[\s\S]*$/,(function(e){return Ln===Tn?e:On(e,this.file.relative)}),{skipBinary:!1})).pipe(o.restore).pipe(p).pipe(_n.replace(/[\s\S]*/,Qn(Ln),{skipBinary:!1})).pipe(p.restore).pipe(n.dest(Ln,{cwd:An}))}));const tr=p(),{cwd:nr,env:rr,targetPath:ar,subModePath:sr,regExpWxResources:pr,regExpUniImportWxss:ir,wxResourcePath:or,currentNamespace:cr,mpTypeNamespace:lr,pluginProcessFileTypes:ur}=_,{writeLastLine:gr,getLevel:fr,getLevelPath:hr}=A,{mixinsEnvCode:mr}=qt,{uniRequireWxResource:dr}=wn,{runPlugins:Pr}=le,yr=[],br=[],vr=[],wr=new Set,jr=new Set;Object.keys(lr).forEach(e=>{yr.push(lr[e].css),br.push(`${or}/**/*.${lr[e].css}`),vr.push(`${or}/**/*.${lr[e].html}`),wr.add("."+lr[e].css),jr.add("."+lr[e].html)}),n.task("subMode:copyWxResource",(function(){const e=tr.filter([or+"/**/*.js"],{restore:!0}),a=tr.filter([...br],{restore:!0}),s=tr.filter([...vr],{restore:!0}),p=tr.filter(ur.map(e=>`${or}/**/*${e}`),{restore:!0});return n.src([or+"/**",or],{allowEmpty:!0,cwd:nr}).pipe(tr.if("dev"===rr,tr.watch([or+"/**",or,`!/${or}/**/*.*___jb_tmp___`],{cwd:nr},(function(e){gr("处理"+e.relative+"......")})))).pipe(e).pipe(tr.replace(/[\s\S]*/,(function(e){return mr(e)+e}),{skipBinary:!1})).pipe(tr.replace(/^/,(function(e){return`require('${hr(fr(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(u()).pipe(dr()).pipe(e.restore).pipe(a).pipe(tr.stripCssComments()).pipe(tr.replace(ir,(function(e,t,n){let r="";fr(this.file.relative);return t+r}),{skipBinary:!1})).pipe(tr.replace(/^[\s\S]*$/,(function(e){return sr===ar?e:On(e,this.file.relative)}),{skipBinary:!1})).pipe(tr.rename((function(e){e.extname="."+cr.css}))).pipe(a.restore).pipe(s).pipe(tr.rename((function(e){e.extname="."+cr.html}))).pipe(s.restore).pipe(tr.filter((function(e){if("unlink"===e.event){try{let n=e.path;const a=RegExp(e.extname+"$","i");wr.has(e.extname)&&(n=n.replace(a,"."+cr.css)),jr.has(e.extname)&&(n=n.replace(a,"."+cr.html)),t.sync([n.replace(r.resolve(nr,or),r.resolve(nr,sr))],{force:!0})}catch(e){}return!1}return!0}))).pipe(p).pipe(tr.replace(/[\s\S]*/,Pr(sr),{skipBinary:!1})).pipe(p.restore).pipe(n.dest(sr,{cwd:nr}))}));const kr=p(),{cwd:xr,target:$r,env:Sr,projectToSubPackageConfig:Or,currentNamespace:_r,mpTypeNamespace:Er,pluginProcessFileTypes:Cr}=_,{writeLastLine:Ar}=A,{mixinsEnvCode:Nr}=qt,{runPlugins:Rr}=le;n.task("watch:native",(function(){const e=Or[_r.mainMpPath],a=[],s=[],p=new Set,i=new Set;Object.keys(Er).forEach(t=>{a.push(`${e}/**/*.${Er[t].css}`),s.push(`${e}/**/*.${Er[t].html}`),p.add("."+Er[t].css),i.add("."+Er[t].html)});const o=kr.filter([e+"/**/*.js"],{restore:!0}),c=kr.filter([...s],{restore:!0}),l=kr.filter([...a],{restore:!0}),u=kr.filter(Cr.map(t=>`${e}/**/*.${t}`),{restore:!0});return n.src([e+"/**/*","!"+e+"/app.json"],{base:r.resolve(xr,e),allowEmpty:!0,cwd:xr}).pipe(kr.if("dev"===Sr,kr.watch([e+"/**/*","!/"+e+"/app.json"],{cwd:xr},(function(e){Ar("处理"+e.relative+"......")})))).pipe(kr.filter((function(n){if("unlink"===n.event){try{let a=n.path;const s=RegExp(n.extname+"$","i");p.has(n.extname)&&(a=a.replace(s,"."+_r.css)),i.has(n.extname)&&(a=a.replace(s,"."+_r.html)),t.sync([a.replace(r.resolve(xr,e),r.resolve(xr,$r))],{force:!0})}catch(e){console.log(e)}return!1}return!0}))).pipe(o).pipe(kr.replace(/[\s\S]*/,(function(e){return Nr(e)+e}),{skipBinary:!1})).pipe(o.restore).pipe(c).pipe(kr.rename((function(e){e.extname="."+_r.html}))).pipe(c.restore).pipe(l).pipe(kr.rename((function(e){e.extname="."+_r.css}))).pipe(l.restore).pipe(u).pipe(kr.replace(/[\s\S]*/,Rr(r.resolve(xr,$r)),{skipBinary:!1})).pipe(u.restore).pipe(n.dest($r,{cwd:xr}))}));const{cwd:Mr,env:Tr,targetPath:Lr,subModePath:Br,projectToSubPackageConfig:qr,program:Fr,currentNamespace:Jr}=_,{tryAgain:Wr}=A;async function Ir(e){let t=r.resolve(Mr,qr[Jr.mainMpPath],"app.js");await c.exists(t)||await c.outputFile(t,"App({});"),e()}n.task("mpWxSubMode",n.series((function(e){console.log("小程序解耦构建开启，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(t){if(Fr.plugin||Fr.native)t();else{try{let e={packPath:(qr.subPackagePath?"/":"")+qr.subPackagePath,appMode:qr.appMode};await c.outputFile(Br+"/pack.config.js","module.exports="+JSON.stringify(e,null,4))}catch(n){return void await Wr(async()=>{await e(t)})}t()}}),function(){let e=[Ir,"subMode:createUniSubPackage","subMode:copyWxResource",...Fr.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...qr.mergePack?["watch:mainWeixinMpPackPath"]:[],...Br===Lr?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return Fr.native&&(e=[Ir,"watch:mainAppJson","watch:native"]),"build"===Tr?n.series.apply(this,e):n.parallel.apply(this,e)}(),(function(e){e(),"build"===Tr&&process.exit()})));const{cwd:Ur,basePath:Kr,base:Dr,program:Hr}=_;n.task("startToPackServe",n.series((async function(e){Hr.native||await c.exists(Kr)||await c.mkdirs(Kr),e()}),"clean:base",(function(e){Hr.native?e():n.watch(Dr+"/app.json",{events:["all"],cwd:Ur},(function(){e()}))}),"mpWxSubMode")),process.on("unhandledRejection",()=>{});
