#!/usr/bin/env node
!function(){const e=require("path"),{program:o}=require("commander"),{spawn:n,spawnSync:i}=require("child_process");if(o.option("--create","创建模板").option("--build <type>","build").option("--plugin","插件模式").option("--type <type>","解耦包类型(哪种小程序)","weixin").option("--native","原生模式"),o.parse(process.argv),o.create){const o=require("fs-extra"),n=process.cwd(),a=require(e.resolve(n,"package.json")),c=require("./template/package.json"),p=require("./template/projectToSubPackageConfig");a.scripts={...c.scripts,...a.scripts||{}},a.dependencies={...c.dependencies,...a.dependencies||{}};const r=e.resolve(n,"projectToSubPackageConfig.js");o.existsSync(r)&&(console.log("备份已存在的projectToSubPackageConfig"),o.copySync(r,r.replace(/$/,".bak_"+Date.now()))),o.copySync(e.resolve(__dirname,"template/projectToSubPackageConfig.js"),e.resolve(n,"projectToSubPackageConfig.js")),console.log("projectToSubPackageConfig植入成功"),o.writeJsonSync(e.resolve(n,"package.json"),a,{spaces:2}),console.log("package.json更新成功"),p.mainWeixinMpPath&&(o.mkdirsSync(e.resolve(n,p.mainWeixinMpPath)),console.log("projectToSubPackageConfig.mainWeixinMpPath创建成功")),p.mainToutiaoMpPath&&(o.mkdirsSync(e.resolve(n,p.mainToutiaoMpPath)),console.log("projectToSubPackageConfig.mainToutiaoMpPath创建成功")),p.mainAlipayMpPath&&(o.mkdirsSync(e.resolve(n,p.mainAlipayMpPath)),console.log("projectToSubPackageConfig.mainAlipayMpPath创建成功"));i("win32"===process.platform?"npm.cmd":"npm",["install","concurrently","cross-env","uniapp2wxpack","-S"],{cwd:process.cwd(),stdio:"inherit"});return}let a={development:"startToPackServe",production:"mpWxSubMode"};a[o.build]?n(process.execPath,[require.resolve("gulp/bin/gulp.js"),a[o.build],"--scope",process.cwd(),...o.plugin?["--plugin"]:[],...o.native?["--native"]:[],"--type",o.type],{cwd:__dirname,stdio:"inherit"}):console.log("缺少参数\n--create\n--build [development/production]")}();